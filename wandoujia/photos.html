<!doctype html>
<html>
  <head>
    <title> For wandoujia.com </title>
    <script src="jquery-1.7.2.js"></script>
    <script src="group.js"></script>
    <style type="text/css">
      body {
      	text-align: center
      }
      li {
      	list-style: none
      }
      img {
      	border: 1px solid #888;
      	padding: 3px;
      	margin: 3px;
      }
      #container {
      	width: 1000px;
      	margin: auto;
      	text-align: left;
      }
      #container li {
      	vertical-align: center;
      	margin: 5px;
      }
      #container p {
      	font-family: 'Microsoft Yahei';
      	font-size: 17px;
      	color: #666;
      }
    </style>
  </head>

  <body>

  	<div id="container">
  	  <ul>
  	  <!-- body -->
  	  </ul>
  	</div>

  </body>
  <script>
  	$(function() {


      function showImages(url, flag) {

      	var nextURL
      	var photos
      	var ratio = 6;

      	var xhr = $.getJSON(url).done(function(data, stats) {
      	
      	  nextURL = data.nextURL
      	  photos  = data.photos
      	  console.log(photos)
      	  group(photos, function(result) {

      	    var htmlstr = ''
      	    for (date in result) {

      	  	  htmlstr += '<li>'
      	  	  htmlstr += '<p>' + date + '</p>'
      	  	  for (var i=0,tmp=result[date],max=tmp.length; i<max; i++) {
      	  		htmlstr += '<img src="' + tmp[i].imageURL + '" style="height:' + tmp[i].height/ratio +'px;width:' + tmp[i].width/ratio + 'px" />'
      	  	  }
      	  	  htmlstr += '</li>'

      	    }
      	    if (flag == 1) {
      	    	$('#container ul').append(htmlstr)
      	    }
      	    else {
      	    	$('#container ul').html(htmlstr)
      	    }
  
      	  })
      	})

      	return {
      	  next: function(fn) {
      	  	if (!nextURL) {
      	  		throw "还没有获得nextURL"
      	  	}
      	  	showImages(nextURL, 1).done(fn)
      	  },
      	  done: xhr.done
      	}
      }

      var imagesCursor = showImages('//photo-sync.herokuapp.com/photos')
      var lock = true

	  $(window).on('scroll', function() {
      	if ($(window).height() + $(window).scrollTop() + 100 > $('body').height()) {
      	  if (lock) {
      	  	imagesCursor.next()
      	  	lock = false
      	  }
      	  imagesCursor.next(function() {
      	  	lock = true
      	  })
        }
      })

  	})
  </script>
</html>