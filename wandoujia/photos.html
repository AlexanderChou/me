<!doctype html>
<html>
  <head>
    <title> For wandoujia.com </title>
    <script src="jquery-1.7.2.js"></script>
    <script src="group.js"></script>
    <style type="text/css">
      body {
      	text-align: center;
      	padding-top: 20px;
      }
      li {
      	list-style: none
      }
      img {
      	border: 1px solid #888;
      	padding: 3px;
      	margin: 3px;
      }
      #container {
      	width: 1000px;
      	margin: auto;
      	text-align: left;
      }
      #container li {
      	vertical-align: center;
      	margin: 5px;
      }
      #container p {
      	font-family: 'Microsoft Yahei';
      	font-size: 17px;
      	font-weight: bold;
      	color: #666;
      }
    </style>
  </head>

  <body>

  	<div id="container">
  	  <p><a target="_blank" href="http://placehold.it/" title="若图片无法载入请先验证placehold服务">验证placehold</a></p>
  	  <ul>
  	  <!-- body -->
  	  </ul>
  	</div>

  </body>
  <script>
  $(function() {

      var nextURL, 		// URL Cursor
        photos,			// Photos Set
        dates = {},		// Date Cache
        ratio = 6.0

      /**
       * @param url   json地址
       * @param flag  标示html/append
       */

      function showImages(url, flag) {

      	return $.getJSON(url).done(function(data, stats) {
      	  nextURL = data.nextURL
      	  photos  = data.photos

      	  var result = group(photos)
      	  var htmlstr = ''
      	  var imgsStr
      	  for (date in result) {

      	  	imgsStr = ''
      	  	for (var i=0,tmp=result[date],max=tmp.length; i<max; i++) {
      	  	  imgsStr += '<img src="'+tmp[i].imageURL+'" style="height:'+tmp[i].height/ratio+'px;width:'+tmp[i].width/ratio+'px" />'
      	  	}

      	  	// 若是在之前就已有日期，则append到相应日期后
      	  	if (dates[date]) {
      	  	  $('#d'+date).append(imgsStr)
      	  	  continue;
      	  	}
      	  	htmlstr += ('<li id="d'+date+'"><p>'+date+'</p>' + imgsStr + '</li>')
      	  	dates[date] = true
      	  }
      	  if (flag == 1) {
      	    $('#container ul').append(htmlstr)
      	  } 
      	  else {
      	    $('#container ul').html(htmlstr)
      	  }
      	})

      	
      }

      var imagesXhr = showImages('//photo-sync.herokuapp.com/photos')
      var lock = false	// 滚动锁

      $(window).on('scroll', function() {
      	if ($(window).height() + $(window).scrollTop() + 200 > $('body').height()) {
      	  if (!lock) {
      	    imagesXhr = showImages(nextURL, 1)
      	    imagesXhr.done(function() {
      	      lock = false
      	    })
      	    lock = true
      	  }
        }
      })

  })
  </script>
</html>
